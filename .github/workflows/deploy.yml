# 部署前端到 GitHub Pages
name: 部署到 GitHub Pages

# 觸發條件
on:
  push:
    branches: [ main ]  # 當推送到 main 分支時觸發
  workflow_dispatch:    # 允許手動觸發

# 權限設定
permissions:
  contents: read      # 讀取儲存庫內容
  pages: write        # 寫入 GitHub Pages
  id-token: write     # 寫入 ID token

# 並發控制：同一時間只允許一個部署
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 建置任務
  build:
    runs-on: ubuntu-latest
    steps:
      # 步驟 1：檢出程式碼
      - name: 檢出程式碼
        uses: actions/checkout@v4
        
      # 步驟 2：設定 Node.js 環境
      - name: 設定 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # 不使用緩存，因為我們會刪除 package-lock.json 來修復 rollup 依賴問題
          
      # 步驟 3：安裝相依套件
      - name: 安裝相依套件
        run: |
          cd edu-match-pro-frontend
          # 完全清理以避免 rollup 可選依賴的緩存問題
          rm -rf node_modules package-lock.json
          # 重新安裝所有依賴，確保可選依賴（如 @rollup/rollup-linux-x64-gnu）被正確安裝
          npm install --legacy-peer-deps
          # 驗證 rollup 的可選依賴是否已安裝
          ls -la node_modules/@rollup/rollup-linux-x64-gnu 2>/dev/null || echo "警告：rollup 平台依賴未找到，但繼續構建"
          
      # 步驟 4：建置專案
      - name: 建置專案
        run: |
          cd edu-match-pro-frontend
          npm run build -- --mode production
        env:
          NODE_ENV: production
          
      # 步驟 5：設定 GitHub Pages
      - name: 設定 GitHub Pages
        uses: actions/configure-pages@v4
        
      # 步驟 6：上傳建置產物
      - name: 上傳建置產物
        uses: actions/upload-pages-artifact@v3
        with:
          path: edu-match-pro-frontend/dist

  # 部署任務
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build  # 依賴 build 任務完成
    steps:
      # 步驟 1：部署到 GitHub Pages
      - name: 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
